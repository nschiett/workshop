---
title: "Workshop on reproducibility and stan"
author: "N.S."
date: "18 February 2019"
output:
  beamer_presentation:
    incremental: yes
    slide_level: 2
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Overview

1. Reproducibility
    - Project workflow
    - Reproducible reports
    - Version control
    
2. Intro to bayesian with rstan and brms

# Part 1: Reproducibilty

## What is reproducibility?
        
         
"*The goal of reproducible research is to tie specific instructions to data analysis and experimental data so that scholarship can be recreated, better understood and verified.*" (CRAN task view on reproducible research)


![](pep_sci.jpg)

## Project workflow

### 1. Principles of a good analysis workflow

- Start analysis = raw data   
- Any cleaning, merging, transforming, etc. of data should be done in scripts, not manually.   
- Split your workflow (scripts) into logical thematic units        
    - 1. Load, merge and clean data   
    - 2. Analyse data    
    - 3. Produce outputs like figures and tables    
- Eliminate code duplication by packaging up useful code into custom functions 
- Document your code and data as comments in your scripts or by producing separate documentation 
- Any intermediary outputs generated by your workflow should be kept separate from raw data



## Project workflow

### 2. File system structure

- Use R projects!!!

- Example basic project directory structure:  
    - Data
    - Plots
    - Output
    - R 
    - Reports
    
## Project workflow

### 3. Principles of naming

- **Machine readable**
    - Avoid spaces, punctuation, accented characters and case sensitivity
    - Use delimiters to separate and make important metadata information retrievable further down the line (i.e. "_")
- **Human readable** 
    - Ensure file names also include informative description of file contents  
- **Data files**
    - Never use spaces or points in column headings
    - Be consistent

## Project workflow

Let's go!     
                 
                    
                     
![](rstudio.png)

## rmarkdown    

R Markdown provides an authoring framework for data science.    
You can use a single R Markdown file to both:    

- save and execute code
- generate reproducible reports 

</center>
![](rmarkdown.png){width=100px}
</center>
## rmarkdown    

![](rmarkdown_wiz.jpeg)
\newline
https://twitter.com/allison_horst

## rmarkdown
### Yaml header
![](yaml.png)



## rmarkdown
### Chunks
![](sreenshot.png)

               
```{r test}
a <- "almost"
b <- "time"
c <- "for"
d <- "coffee"
hope <- c(a,b,c,d)
paste(hope, collapse = " ")
```

## rmarkdown
### Chunk options
- eval
- include
- echo
- message
- warning
- error
- fig.height, fig.width

## rmarkdown    

![](rmarkdown_1.png)
\newline

## rmarkdown    

![](rmarkdown_2.png)
\newline

## rmarkdown

Let's go!     
                 
                    
                     
![](rstudio.png)

## Version control
- The management of changes to documents, computer programs, large web sites, and other collections of information
- git: Open source version control system

- GitHub: Remote platform

![](github.jpeg){width=200px}

## Version control
![](git_workflow.png)

## Version control
#### git configuration
```
git config --global user.email "youremail.com"
git config --global user.name "yourname"
```
#### Connect with github
```
git remote add origin https://github.com/name/project.git
git config remote.origin.url git@github.com:name/project.git
git pull -u origin master
git push -u origin master
```

# Part 2: Bayesian with stan

## Bayesian inference
"*Probability is orderly opinion and inference from data is nothing other than the revision of such opinion in the light of relevant new information.*" (Thomas Bayes)
```{r  out.width = "50%", echo=FALSE, fig.align='center'}
knitr::include_graphics("thomas.jpeg") 
```

## Bayesian inference

“*How often have I said to you that when you have eliminated the impossible, whatever remains, however improbable, must be the truth?*” (Doyle , 1890, chap. 6)      

```{r  out.width = "30%", echo=FALSE, fig.align='center'}
knitr::include_graphics("cred1.png") 

```

## Bayesian inference
 
```{r  out.width = "40%", echo=FALSE, fig.align='center'}
knitr::include_graphics("cred2.png") 

```

## Bayesian inference

```{r  out.width = "70%", echo=FALSE, fig.align='center'}
knitr::include_graphics("bayes_rule.png") 
knitr::include_graphics("bayes.jpg") 
```
## Stan
```{r  out.width = "70%", echo=FALSE, fig.align='center'}
knitr::include_graphics("stan.jpeg")  
```

## Stan

Stan is a state-of-the-art platform for statistical modeling and high-performance statistical computation.

- Programming language
- Algorithms
- Open source
- Interfaces and tools (R, Python, etc)

```{r  out.width = "20%", echo=FALSE, fig.align='center'}
knitr::include_graphics("stan_logo.png")  
```


## Workflow   

- 1. Exploratory data analysis
- 2. Specify model
- 3. *Prior* predictive checking
- 4. Model fitting and algorithm diagnostics
- 5. *Posterior* predictive checking
- 6. Model comparison (e.g., via cross-validation) 

## Stan program  

- Stan program has three required “blocks”:

  -1. **“data”** block: where you declare the data types, their dimensions, any restrictions and their names

  -2. **“parameters”** block: This is where you indicate the parameters you want to model, their dimensions, restrictions, and name

  -3. **“model”** block: This is where you describe the model you are using and indicate any prior distributions you want to include for your parameters.

- Optional blocks:
  - functions
  - transformed data
  - transformed parameters
  - generated quantities 

## Stan program 

stan_model.stan:
```{}
// Stan model for simple linear regression
data {
 int < lower = 1 > N; // Sample size
 vector[N] y; // Data
}
parameters {
 real mu; // Average 
 real < lower = 0 > sigma; // Error SD
}
model {
 mu ~ normal(0, 100);
 y ~ normal(mu, sigma);
}
```

## rstan

```{r, eval = FALSE}
# Prepare data
data <- list(
  N = length(datavector),
  y = datavector
)
# Compile stan model
stan_model <- rstan::stan_model("stan_model.stan")
# Fit model
stanfit <- rstan::sampling(stan_model, data = data)
```


## Workflow   

1. Exploratory data analysis
2. Specify model
3. *Prior* predictive checking
4. Model fitting and algorithm diagnostics
5. *Posterior* predictive checking
6. Model comparison (e.g., via cross-validation) 

